name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "🚀 Starting deployment..."
            if [ ! -d "/var/www/nuxt_social2" ]; then
              echo "📁 Directory /var/www/nuxt_social2 not found, creating it..."
              sudo mkdir -p /var/www/nuxt_social2
            fi

            cd /var/www/nuxt_social2 || exit 1

            # Remove everything in the folder
            echo "🧹 Cleaning up old files..."
            sudo rm -rf ./*

            # Clone the repo
            echo "📥 Cloning repository..."
            sudo git clone https://github.com/SajadSalam/Pomelo.SocialMedia.git

            # mv Pomelo.SocialMedia to nuxt_social2
            echo "🔍 Moving Pomelo.SocialMedia to nuxt_social2..."
            sudo mv Pomelo.SocialMedia/* .
            sudo mv Pomelo.SocialMedia/.* .
            sudo rm -rf Pomelo.SocialMedia

            # Create .env file
            echo "🔐 Creating .env file..."
            echo "${{ secrets.ENV_FILE }}" > .env

            # Install dependencies
            echo "📦 Installing dependencies..."
            pnpm install --no-frozen-lockfile

            # Generate Prisma client
            echo "🔧 Generating Prisma client..."
            pnpm run db:generate

            # Run database migrations
            echo "🗄️  Running migrations..."
            npx prisma migrate deploy

            # Verify database
            if [ -f "prisma/dev.db" ]; then
              echo "✅ Database verified at prisma/dev.db"
              ls -lh prisma/dev.db
            else
              echo "⚠️  Database file not found, may be using PostgreSQL"
            fi

            # Build the project
            echo "🏗️  Building project..."
            pnpm run build

            # Restart the service
            echo "♻️  Restarting service..."
            sudo systemctl restart Social.service

            echo "✅ Deployment completed successfully!"
