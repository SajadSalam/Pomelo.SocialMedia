name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ğŸš€ Starting deployment..."
            if [ ! -d "/var/www/nuxt_social" ]; then
              echo "ğŸ“ Directory /var/www/nuxt_social not found, creating it..."
              sudo mkdir -p /var/www/nuxt_social
            fi

            cd /var/www/nuxt_social || exit 1

            # Remove everything in the folder
            echo "ğŸ§¹ Cleaning up old files..."
            sudo rm -rf ./*

            # Clone the repo
            echo "ğŸ“¥ Cloning repository..."
            sudo git clone https://github.com/SajadSalam/Pomelo.SocialMedia.git

            # mv Pomelo.SocialMedia to nuxt_social
            echo "ğŸ” Moving Pomelo.SocialMedia to nuxt_social..."
            sudo mv Pomelo.SocialMedia/* .
            sudo mv Pomelo.SocialMedia/.* .
            sudo rm -rf Pomelo.SocialMedia

            # Create .env file
            echo "ğŸ” Creating .env file..."
            echo "${{ secrets.ENV_FILE }}" > .env

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            pnpm install --no-frozen-lockfile

            # Generate Prisma client
            echo "ğŸ”§ Generating Prisma client..."
            pnpm run db:generate

            # Run database migrations
            echo "ğŸ—„ï¸  Running migrations..."
            npx prisma migrate deploy

            # Verify database
            if [ -f "prisma/dev.db" ]; then
              echo "âœ… Database verified at prisma/dev.db"
              ls -lh prisma/dev.db
            else
              echo "âš ï¸  Database file not found, may be using PostgreSQL"
            fi

            # Build the project
            echo "ğŸ—ï¸  Building project..."
            pnpm run build

            # Restart the service
            echo "â™»ï¸  Restarting service..."
            pm2 restart Social

            echo "âœ… Deployment completed successfully!"
      - name: send notification to telegram
        uses: appleboy/telegram-action@master
        with:
          to: -1003046981339
          token: 1798483416:AAEPm2r9l6rdhHyeeovRAiL2db5sKigLNKo
          message: |
            [Produaction Environment]
            [${{ github.event.head_commit.committer.name }}](https://github.com/${{github.event.head_commit.committer.username}}) pushed new commit:
            `[ ${{github.event.head_commit.message}} ]`
            to [${{ github.event.repository.name }}](https://github.com/${{github.event.repository.html_url}})
          format: markdown
          disable_web_page_preview: true
