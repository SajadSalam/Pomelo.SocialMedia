name: CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e  # Exit on error

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Starting deployment..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            # Ensure directory exists
            if [ ! -d "/var/www/nuxt_social2" ]; then
              echo "ğŸ“ Creating directory /var/www/nuxt_social2..."
              sudo mkdir -p /var/www/nuxt_social2
              sudo chown -R $USER:$USER /var/www/nuxt_social2
            fi

            cd /var/www/nuxt_social2 || exit 1

            # Backup .env if exists
            if [ -f ".env" ]; then
              echo "ğŸ’¾ Backing up .env file..."
              cp .env .env.backup
            fi

            # Backup database if exists
            if [ -f "prisma/dev.db" ]; then
              echo "ğŸ’¾ Backing up database..."
              cp prisma/dev.db prisma/dev.db.backup
            fi

            # Clean up old files (preserve backups)
            echo "ğŸ§¹ Cleaning up old files..."
            find . -mindepth 1 -maxdepth 1 ! -name '.env.backup' ! -name 'prisma' ! -name 'node_modules' -exec sudo rm -rf {} +

            # Clone the repo
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/SajadSalam/Pomelo.SocialMedia.git temp_clone

            # Move files
            echo "ğŸ“¦ Moving files..."
            shopt -s dotglob
            mv temp_clone/* .
            rm -rf temp_clone

            # Restore .env
            if [ -f ".env.backup" ]; then
              echo "ğŸ” Restoring .env file..."
              mv .env.backup .env
            else
              echo "ğŸ” Creating .env file from secrets..."
              echo "${{ secrets.ENV_FILE }}" > .env
            fi

            # Restore database
            if [ -f "prisma/dev.db.backup" ]; then
              echo "ğŸ—„ï¸  Restoring database..."
              mv prisma/dev.db.backup prisma/dev.db
            fi

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            pnpm install --frozen-lockfile || pnpm install

            # Generate Prisma client (always)
            echo "ğŸ”§ Generating Prisma client..."
            pnpm db:generate

            # Setup database
            echo "ğŸ—„ï¸  Setting up database..."
            if [ -f "prisma/migrations" ]; then
              echo "Running migrations..."
              pnpm db:deploy || pnpm db:push
            else
              echo "Using db push (no migrations)..."
              pnpm db:push
            fi

            # Verify Prisma Client
            if [ -d "node_modules/.prisma/client" ]; then
              echo "âœ… Prisma Client generated successfully"
            else
              echo "âŒ Prisma Client not found! Regenerating..."
              pnpm db:generate
            fi

            # Verify database
            if [ -f "prisma/dev.db" ]; then
              echo "âœ… Database verified"
              ls -lh prisma/dev.db
            else
              echo "âš ï¸  SQLite database not found (may be using different DB)"
            fi

            # Build the project
            echo "ğŸ—ï¸  Building application..."
            pnpm build

            # Verify build output
            if [ -f ".output/server/index.mjs" ]; then
              echo "âœ… Build output verified"
            else
              echo "âŒ Build output not found!"
              exit 1
            fi

            # Restart service
            echo "â™»ï¸  Restarting service..."

            # Try PM2 first
            if command -v pm2 &> /dev/null; then
              echo "Using PM2..."
              pm2 restart social-media-manager 2>/dev/null || pm2 start ecosystem.config.cjs
              pm2 save
              echo "âœ… PM2 service restarted"
            # Then try systemd
            elif systemctl is-active --quiet Social.service 2>/dev/null; then
              echo "Using systemd..."
              sudo systemctl restart Social.service
              echo "âœ… Systemd service restarted"
            else
              echo "âš ï¸  No service manager found (PM2 or systemd)"
              echo "ğŸ’¡ Please manually start the application with:"
              echo "   pm2 start ecosystem.config.cjs"
              echo "   OR"
              echo "   pnpm start"
            fi

            # Check service status
            echo ""
            echo "ğŸ” Checking service status..."
            if command -v pm2 &> /dev/null; then
              pm2 list | grep social-media-manager || echo "Service not running with PM2"
            fi

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“Š Deployment Summary:"
            echo "   - Dependencies: Installed"
            echo "   - Prisma Client: Generated"
            echo "   - Database: Ready"
            echo "   - Build: Completed"
            echo "   - Service: Restarted"
            echo ""
            echo "ğŸŒ Application should be running!"
            echo ""
